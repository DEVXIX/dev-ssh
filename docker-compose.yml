services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dev-ssh-server
    restart: unless-stopped
    ports:
      - "5000:5000"
    extra_hosts:
      # Allow container to reach host machine services (e.g., local databases)
      - "host.docker.internal:host-gateway"
    environment:
      - NODE_ENV=production
      - PORT=5000
      - DATABASE_PATH=/app/data/database.db
      # These will be loaded from .env file or can be set here
      - JWT_SECRET=${JWT_SECRET}
      - SESSION_SECRET=${SESSION_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000}
      - REQUIRE_HTTPS=${REQUIRE_HTTPS:-false}
      # Guacd connection for RDP/VNC
      - GUACD_HOST=guacd
      - GUACD_PORT=4822
    depends_on:
      - guacd
    volumes:
      # Persist database data
      - ./data:/app/data
      # Optional: mount custom .env file
      # - ./.env:/app/.env:ro
    networks:
      - dev-ssh-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Security options
    security_opt:
      - no-new-privileges:true
    # Resource limits (adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend.bun
    container_name: dev-ssh-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    depends_on:
      - app
    networks:
      - dev-ssh-network
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:3000').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    # Security options
    security_opt:
      - no-new-privileges:true
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  # Guacamole daemon for RDP/VNC connections with full NLA support
  guacd:
    image: guacamole/guacd:latest
    container_name: dev-ssh-guacd
    restart: unless-stopped
    networks:
      - dev-ssh-network
    # Expose guacd port to the app service
    expose:
      - "4822"
    # Optional: mount for drive redirection
    volumes:
      - ./guacd-drive:/drive:rw
      - ./guacd-record:/record:rw
    environment:
      - GUACD_LOG_LEVEL=info

networks:
  dev-ssh-network:
    driver: bridge
